<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Outfit', sans-serif;
      background: transparent;
      color: #1C2526;
      padding: 10px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .form-wrapper {
      max-width: 500px;
      width: 100%;
      background: transparent;
      padding: 10px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }
    .progress-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .progress-step {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #1C2526;
    }
    .progress-step.active { color: #1AB0D8; font-weight: 500; }
    .progress-step::before {
      content: '';
      display: block;
      width: 8px;
      height: 8px;
      background: #e0e0e0;
      border-radius: 50%;
      margin: 0 auto 5px;
    }
    .progress-step.active::before { background: #1AB0D8; }
    .step { display: none; }
    .step.active { display: block; }
    .inputs-container {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      padding: 10px;
    }
    .form-group { margin-bottom: 12px; position: relative; }
    label { font-size: 12px; margin-bottom: 4px; display: block; }
    input, select {
      width: 100%;
      padding: 7px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 4px;
      font-size: 12px;
    }
    input:focus, select:focus { border-color: #1AB0D8; outline: none; }
    .error-message {
      display: none;
      color: #e57373;
      font-size: 10px;
      position: absolute;
      bottom: -16px;
      left: 0;
    }
    .form-group.error .error-message { display: block; }
    .form-group.error input, .form-group.error select {
      border-color: #e57373;
      background: #fff1f1;
    }
    .buttons {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      justify-content: space-between;
      align-items: center;
    }
    button {
      padding: 7px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      color: #fff;
      cursor: pointer;
      flex: 1;
      max-width: 80px;
    }
    button:disabled {
      background: #b0b0b0;
      border: 1px solid #999;
      opacity: 0.6;
      cursor: not-allowed;
    }
    #prevBtn { background: #b0b0b0; }
    #prevBtn:hover:not(:disabled) { background: #999; }
    #nextBtn, #submitBtn { background: #1AB0D8; }
    #nextBtn:hover:not(:disabled), #submitBtn:hover:not(:disabled) { background: #1591B2; }
    #message {
      flex: 2;
      font-size: 11px;
      text-align: center;
      min-height: 24px;
    }
    #message.success { color: #2e7d32; }
    #message.error { color: #c62828; }
    #loading { display: none; font-size: 10px; text-align: center; margin-top: 10px; }
    @media (max-width: 600px) {
      body { padding: 8px; }
      .form-wrapper { padding: 8px; }
      .progress-bar { margin-bottom: 8px; }
      .progress-step, label, input, select, button { font-size: 11px; }
      .progress-step::before { width: 7px; height: 7px; }
      .inputs-container, .form-group { padding: 8px; margin-bottom: 10px; }
      button { padding: 6px 10px; max-width: 70px; }
      #message { font-size: 10px; }
    }
    @media (max-width: 360px) {
      .form-wrapper { padding: 6px; }
      .progress-step, label, input, select, button { font-size: 10px; }
      button { max-width: 60px; }
    }
  </style>
</head>
<body>
  <div class="form-wrapper">
    <div class="progress-bar">
      <div class="progress-step active">Datos Personales</div>
      <div class="progress-step">Datos de Pago</div>
      <div class="progress-step">Dirección</div>
    </div>
    <form id="packageForm" novalidate>
      <div class="step active">
        <div class="inputs-container">
          <div class="form-group">
            <label for="firstName">Nombre:</label>
            <input id="firstName" name="firstName" pattern="[A-Za-z\s\-']+" placeholder="Nombre" required aria-required="true" aria-describedby="firstName-error" />
            <span class="error-message" id="firstName-error">Formato inválido</span>
          </div>
          <div class="form-group">
            <label for="lastName">Apellidos:</label>
            <input id="lastName" name="lastName" pattern="[A-Za-z\s\-']+" placeholder="Apellidos" required aria-required="true" aria-describedby="lastName-error" />
            <span class="error-message" id="lastName-error">Formato inválido</span>
          </div>
          <div class="form-group">
            <label for="emailAddress">Correo:</label>
            <input type="email" id="emailAddress" name="emailAddress" placeholder="correo@ejemplo.com" required aria-required="true" aria-describedby="emailAddress-error" />
            <span class="error-message" id="emailAddress-error">Correo inválido</span>
          </div>
          <div class="form-group">
            <label for="phoneNumber">Teléfono:</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" pattern="\d{10,15}" placeholder="Teléfono" required aria-required="true" aria-describedby="phoneNumber-error" />
            <span class="error-message" id="phoneNumber-error">Solo números</span>
          </div>
        </div>
      </div>
      <div class="step">
        <div class="inputs-container">
          <div class="form-group">
            <label for="cardName">Nombre en tarjeta:</label>
            <input id="cardName" name="cardName" pattern="[A-Za-z\s\-']+" placeholder="Nombre en tarjeta" required aria-required="true" aria-describedby="cardName-error" />
            <span class="error-message" id="cardName-error">Formato inválido</span>
          </div>
          <div class="form-group">
            <label for="cardNumber">Número de tarjeta:</label>
            <input type="tel" id="cardNumber" name="cardNumber" pattern="\d{4}\s?\d{4}\s?\d{4}\s?\d{4}" placeholder="1234 5678 9012 3456" required aria-required="true" aria-describedby="cardNumber-error" />
            <span class="error-message" id="cardNumber-error">Número inválido</span>
          </div>
          <div class="form-group">
            <label for="cvv">CVV:</label>
            <input type="tel" id="cvv" name="cvv" pattern="\d{3,4}" maxlength="4" placeholder="CVV" required aria-required="true" aria-describedby="cvv-error" />
            <span class="error-message" id="cvv-error">CVV inválido</span>
          </div>
          <div class="form-group">
            <label for="expMonth">Mes:</label>
            <input type="number" id="expMonth" name="expMonth" min="1" max="12" placeholder="MM" required aria-required="true" aria-describedby="expMonth-error" />
            <span class="error-message" id="expMonth-error">Mes inválido</span>
          </div>
          <div class="form-group">
            <label for="expYear">Año:</label>
            <input type="number" id="expYear" name="expYear" min="2025" max="2035" placeholder="YYYY" required aria-required="true" aria-describedby="expYear-error" />
            <span class="error-message" id="expYear-error">Año inválido</span>
          </div>
        </div>
      </div>
      <div class="step">
        <div class="inputs-container">
          <div class="form-group">
            <label for="address">Dirección:</label>
            <input id="address" name="address" pattern="[A-Za-z0-9\s\-,.]+" placeholder="Calle y número" required aria-required="true" aria-describedby="address-error" />
            <span class="error-message" id="address-error">Dirección inválida</span>
          </div>
          <div class="form-group">
            <label for="countryCode">País:</label>
            <select id="countryCode" name="countryCode" required aria-required="true" aria-describedby="countryCode-error">
              <option value="">Selecciona un país</option>
              <option value="US">Estados Unidos</option>
              <option value="MX">México</option>
              <option value="ES">España</option>
              <option value="CA">Canadá</option>
            </select>
            <span class="error-message" id="countryCode-error">Selecciona un país</span>
          </div>
          <div class="form-group">
            <label for="stateProvince">Estado:</label>
            <input id="stateProvince" name="stateProvince" pattern="[A-Za-z\s\-]+" placeholder="Estado" required aria-required="true" aria-describedby="stateProvince-error" />
            <span class="error-message" id="stateProvince-error">Formato inválido</span>
          </div>
          <div class="form-group">
            <label for="city">Ciudad:</label>
            <input id="city" name="city" pattern="[A-Za-z\s\-]+" placeholder="Ciudad" required aria-required="true" aria-describedby="city-error" />
            <span class="error-message" id="city-error">Formato inválido</span>
          </div>
          <div class="form-group">
            <label for="postalCode">Código postal:</label>
            <input type="tel" id="postalCode" name="postalCode" pattern="\d{5}" placeholder="Código postal" required aria-required="true" aria-describedby="postalCode-error" />
            <span class="error-message" id="postalCode-error">Código inválido</span>
          </div>
          <input type="hidden" name="ipAddress" value="127.0.0.1" />
        </div>
        <div id="loading">Enviando...</div>
      </div>
      <div class="buttons">
        <button type="button" id="prevBtn" style="display: none;">Atrás</button>
        <div id="message"></div>
        <button type="button" id="nextBtn">Siguiente</button>
        <button type="submit" id="submitBtn" style="display: none;">Enviar</button>
      </div>
    </form>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('packageForm');
      const steps = document.querySelectorAll('.step');
      const progressSteps = document.querySelectorAll('.progress-step');
      const nextBtn = document.getElementById('nextBtn');
      const prevBtn = document.getElementById('prevBtn');
      const submitBtn = document.getElementById('submitBtn');
      const messageDiv = document.getElementById('message');
      const loading = document.getElementById('loading');
      let currentStep = 0;

      const showStep = (index) => {
        steps.forEach((s, i) => s.classList.toggle('active', i === index));
        progressSteps.forEach((p, i) => p.classList.toggle('active', i <= index));
        prevBtn.style.display = index > 0 ? 'block' : 'none';
        nextBtn.style.display = index < steps.length - 1 ? 'block' : 'none';
        submitBtn.style.display = index === steps.length - 1 ? 'block' : 'none';
      };

      const validateInput = (input) => {
        const group = input.closest('.form-group');
        group.classList.remove('error');
        if (!input.checkValidity() || (input.required && !input.value.trim())) {
          group.classList.add('error');
          return false;
        }
        return true;
      };

      const validateStep = () => {
        const inputs = steps[currentStep].querySelectorAll('input, select');
        let isValid = true;
        inputs.forEach(i => { if (!validateInput(i)) isValid = false; });
        if (!isValid) showMessage('Completa los campos', 'error');
        return isValid;
      };

      const validateCardNumber = (num) => {
        const digits = num.replace(/\D/g, '');
        if (digits.length !== 16) return false;
        let sum = 0, isEven = false;
        for (let i = digits.length - 1; i >= 0; i--) {
          let d = parseInt(digits[i]);
          if (isEven) { d *= 2; if (d > 9) d -= 9; }
          sum += d;
          isEven = !isEven;
        }
        return sum % 10 === 0;
      };

      const validateExpirationDate = () => {
        const month = parseInt(document.getElementById('expMonth').value);
        const year = parseInt(document.getElementById('expYear').value);
        const now = new Date();
        return !(year < now.getFullYear() || (year === now.getFullYear() && month < now.getMonth() + 1));
      };

      const showMessage = (msg, type) => {
        messageDiv.className = type;
        messageDiv.textContent = msg;
        setTimeout(() => { messageDiv.className = ''; messageDiv.textContent = ''; }, 2000);
      };

      const inputRules = {
        firstName: /^[A-Za-z\s\-']$/,
        lastName: /^[A-Za-z\s\-']$/,
        cardName: /^[A-Za-z\s\-']$/,
        phoneNumber: /^\d$/,
        cvv: /^\d$/,
        postalCode: /^\d$/,
        cardNumber: /^[\d\s]$/,
        address: /^[A-Za-z0-9\s\-,.]$/,
        stateProvince: /^[A-Za-z\s\-]$/,
        city: /^[A-Za-z\s\-]$/,
      };

      const setupInputs = () => {
        form.querySelectorAll('input, select').forEach(input => {
          input.addEventListener('input', () => validateInput(input));
          input.addEventListener('blur', () => input.required && validateInput(input));
          input.addEventListener('keydown', e => {
            if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) return;
            if (inputRules[input.id] && !inputRules[input.id].test(e.key)) e.preventDefault();
          });
        });
        const cardNumber = document.getElementById('cardNumber');
        cardNumber.addEventListener('input', e => {
          let v = e.target.value.replace(/\D/g, '').replace(/(\d{4})/g, '$1 ').trim();
          e.target.value = v.slice(0, 19);
        });
        document.querySelectorAll('#expMonth, #expYear').forEach(i => {
          i.addEventListener('input', () => i.value = i.value.replace(/[^0-9]/g, ''));
        });
      };

      const handleApiResponse = (data) => {
        const { status } = data || {};
        if (!status) return showMessage('Error de servidor', 'error');
        if (status === 'Approved') {
          showMessage('Pago aprobado', 'success');
          form.reset();
          currentStep = 0;
          showStep(0);
        } else if (status === 'Error' || status === 'Declined' || status === 'Rejected') {
          showMessage('Pago fallido', 'error');
        } else {
          showMessage('Estado desconocido', 'error');
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateStep()) return;

        if (currentStep === 1) {
          if (!validateCardNumber(document.getElementById('cardNumber').value)) {
            showMessage('Tarjeta inválida', 'error');
            return;
          }
          if (!validateExpirationDate()) {
            showMessage('Fecha inválida', 'error');
            return;
          }
        }

        if (currentStep < steps.length - 1) {
          currentStep++;
          showStep(currentStep);
          return;
        }

        loading.style.display = 'block';
        const formData = new FormData(form);
        const jsonData = { planReferenceId: 'Professional' };
        formData.forEach((v, k) => {
          jsonData[k] = k === 'cardNumber' ? v.replace(/\s/g, '') : (isNaN(v) || ['cvv', 'postalCode', 'phoneNumber'].includes(k)) ? v : Number(v);
        });

        try {
          const res = await fetch('https://duelazo-2a8ce83c75f7.herokuapp.com/packages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData),
          });
          if (!res.ok) throw new Error('Error de red');
          handleApiResponse(await res.json());
        } catch {
          showMessage('Error de conexión', 'error');
        } finally {
          loading.style.display = 'none';
        }
      };

      nextBtn.addEventListener('click', () => validateStep() && currentStep < steps.length - 1 && showStep(++currentStep));
      prevBtn.addEventListener('click', () => currentStep > 0 && showStep(--currentStep));
      form.addEventListener('submit', handleSubmit);
      setupInputs();
      showStep(0);
    });
  </script>
</body>
</html>
